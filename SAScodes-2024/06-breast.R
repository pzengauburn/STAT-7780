######################################################################
# STAT 7780 - Survival Analysis 
# Peng Zeng (Auburn University)
# 2024-10-01 
######################################################################

rm(list = ls())
ex = read.csv("http://www.auburn.edu/~zengpen/teaching/STAT-7780/datasets/btrial.csv"); 
str(ex); 
# ex$im = 1 for negative and = 2 for positive 

time = unique(sort(ex$time[ex$death == 1])); 
D = length(time); 
Y0 = numeric(D);
Y1 = numeric(D); 

d1 = sum((ex$death == 1) & (ex$im == 2));
for(i in 1:D)
{
    Y0[i] = length(ex$time[(ex$im == 1) & (ex$time >= time[i])]);
    Y1[i] = length(ex$time[(ex$im == 2) & (ex$time >= time[i])]);
}
cbind(Y0, Y1);

LL = function(b) {  b * d1 - sum(log(Y0 + Y1 * exp(b))) };
Ufun = function(b) { d1 - sum(Y1 * exp(b) / (Y0 + Y1 * exp(b))) }; 
Ifun = function(b) { sum(Y0 * Y1 * exp(b) / (Y0 + Y1 * exp(b))^2) }; 

######################################################################
# compute estimate 
######################################################################

b = 0; 
for(i in 1:10)
{
    b = b + Ufun(b) / Ifun(b); 
    cat("i = ", i, "b = ", b, "\n")
}

######################################################################
# compute standard error  
######################################################################

1 / sqrt(Ifun(b))

######################################################################
# likelihood ratio test 
######################################################################

X.LR = 2 * (LL(b) - LL(0));
1 - pchisq(X.LR, df = 1)

######################################################################
# Wald test 
######################################################################

X.W = b^2 * Ifun(b);
1 - pchisq(X.W, df = 1)

######################################################################
# score test 
######################################################################

X.SC = Ufun(0)^2 / Ifun(0);
1 - pchisq(X.SC, df = 1)

######################################################################
# THE END 
######################################################################
